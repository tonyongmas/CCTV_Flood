<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏≠‡∏∏‡∏ó‡∏Å‡∏†‡∏±‡∏¢ (CCTV) ‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ï‡∏≥‡∏ö‡∏•‡∏ï‡∏±‡∏ô‡∏´‡∏¢‡∏á‡∏°‡∏±‡∏™</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- Color Palette --- */
        :root {
            --primary-blue: #0056b3;
            --dark-blue: #004494;
            --light-blue-bg: #eef6fc;
            --text-dark: #333333;
            --text-gray: #666666;
        }

        body {
            margin: 0; padding: 0; font-family: 'Sarabun', sans-serif;
            overflow: hidden; display: flex; flex-direction: column;
            height: 100vh; background-color: var(--light-blue-bg);
        }

        /* --- Header --- */
        header {
            background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            color: white; padding: 12px 20px;
            display: flex; align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            flex: 0 0 auto; z-index: 1000;
        }
        .header-logo { width: 55px; height: auto; margin-right: 15px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        .header-titles h1 { margin: 0; font-size: 20px; font-weight: 700; line-height: 1.2; }
        .header-titles p { margin: 2px 0 0 0; font-size: 14px; opacity: 0.9; }

        /* --- Map --- */
        #map { flex: 1 1 auto; width: 100%; z-index: 1; }

        /* --- Pulse Animation --- */
        .pulse-icon { border-radius: 50%; box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.7); }
        .pulse-normal { animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(40, 167, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); } }
        .pulse-warning { animation: pulse-yellow 2s infinite; }
        @keyframes pulse-yellow { 0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 193, 7, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); } }
        .pulse-danger { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }

        /* --- Loader --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(238, 246, 252, 0.98); z-index: 10000;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: var(--primary-blue);
        }
        .spinner {
            border: 4px solid #d0e7ff; border-top: 4px solid var(--primary-blue);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Modal Layout --- */
        .custom-modal-overlay {
            display: none; position: fixed; z-index: 9999;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0, 20, 40, 0.85); backdrop-filter: blur(5px);
            justify-content: center; align-items: center; padding: 15px; box-sizing: border-box;
        }

        .custom-modal-content {
            background-color: #fff; border-radius: 16px;
            width: 100%; max-width: 550px; position: relative;
            animation: popIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 90vh; overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.4); display: flex; flex-direction: column; overflow: hidden;
        }
        @keyframes popIn { from {transform: scale(0.95); opacity: 0;} to {transform: scale(1); opacity: 1;} }

        /* Media Area */
        .modal-media-wrapper {
            width: 100%; height: 280px; background-color: #000;
            position: relative; display: flex; align-items: center; justify-content: center;
        }
        
        .modal-image { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; /* ‡∏õ‡∏Å‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏î‡∏Ç‡∏≠‡∏ö */
        }

        /* --- [FIX] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ Fullscreen ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ --- */
        /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ contain ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î Fullscreen */
        #activeImage:fullscreen,
        #activeImage:-webkit-full-screen,
        #activeImage:-moz-full-screen,
        #activeImage:-ms-fullscreen {
            object-fit: contain !important; /* ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡πÄ‡∏ï‡πá‡∏°‡πÉ‡∏ö ‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏Ç‡∏≠‡∏ö */
            background-color: black;
            width: 100vw;
            height: 100vh;
        }

        /* LIVE Badge */
        .live-badge {
            position: absolute; top: 15px; left: 15px;
            background-color: #ff0000; color: white; padding: 4px 10px; border-radius: 4px;
            font-size: 12px; font-weight: 700; letter-spacing: 0.5px;
            display: flex; align-items: center; gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 20;
        }
        .live-dot { width: 8px; height: 8px; background-color: white; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 0% {opacity: 1;} 50% {opacity: 0.3;} 100% {opacity: 1;} }

        /* Buttons */
        .floating-close-btn {
            position: absolute; top: 15px; right: 15px;
            background: rgba(0,0,0,0.4); color: white;
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; cursor: pointer; transition: 0.2s;
            border: 1px solid rgba(255,255,255,0.3); z-index: 20; line-height: 0; padding-bottom: 2px;
        }
        .floating-close-btn:hover { background: rgba(220,53,69,0.9); border-color: transparent; }

        .fullscreen-btn {
            position: absolute; bottom: 15px; right: 15px;
            background: rgba(0,0,0,0.6); color: white;
            width: 35px; height: 35px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 20; transition: 0.2s;
            backdrop-filter: blur(2px); border: 1px solid rgba(255,255,255,0.2);
        }
        .fullscreen-btn:hover { background: rgba(0,0,0,0.9); transform: scale(1.1); }
        .fullscreen-btn svg { width: 20px; height: 20px; }

        /* Info Body */
        .modal-info-body { padding: 25px; }
        .modal-header-row {
            display: flex; justify-content: space-between; align-items: flex-start;
            gap: 15px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;
        }
        .modal-title-text { margin: 0; font-size: 20px; font-weight: 700; color: var(--primary-blue); line-height: 1.3; flex: 1; }
        .status-badge {
            flex: 0 0 auto; padding: 6px 14px; border-radius: 30px;
            color: white; font-size: 14px; font-weight: 600;
            display: flex; align-items: center; gap: 5px; box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        .lat-long-row {
            display: inline-flex; align-items: center; gap: 6px;
            color: var(--text-gray); font-size: 13px;
            background: #f1f4f8; padding: 6px 12px; border-radius: 6px;
            margin-bottom: 20px; font-weight: 500;
        }
        .detail-section-title {
            font-size: 16px; font-weight: 700; color: var(--text-dark);
            margin-bottom: 10px; display: flex; align-items: center; gap: 8px;
        }
        .detail-text {
            font-size: 15px; line-height: 1.6; color: #444;
            background-color: #fafafa; padding: 15px;
            border-left: 4px solid var(--primary-blue); border-radius: 0 8px 8px 0;
        }
        .modal-footer { padding: 0 25px 25px 25px; }
        .close-action-btn {
            background-color: var(--primary-blue); color: white; width: 100%;
            padding: 14px; border: none; border-radius: 12px;
            font-size: 16px; font-weight: 600; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,86,179,0.2); transition: 0.2s;
        }
        .close-action-btn:hover { background-color: var(--dark-blue); }

        @media (max-width: 600px) { 
        .modal-media-wrapper { height: 220px; } 
        .fullscreen-btn { display: none !important; } /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å */
        }
    </style>
</head>
<body>

    <header>
        <img src="https://img2.pic.in.th/pic/71f81565dc59a7f9545542493a5514ab.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•" class="header-logo">
        <div class="header-titles">
            <h1>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏≠‡∏∏‡∏ó‡∏Å‡∏†‡∏±‡∏¢ (CCTV)</h1>
            <p>‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ï‡∏≥‡∏ö‡∏•‡∏ï‡∏±‡∏ô‡∏´‡∏¢‡∏á‡∏°‡∏±‡∏™</p>
        </div>
    </header>

    <div id="loader">
        <div class="spinner"></div><div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    </div>

    <div id="map"></div>

    <div id="infoModal" class="custom-modal-overlay" onclick="handleOverlayClick(event)">
        <div class="custom-modal-content">
            
            <div class="modal-media-wrapper" id="modalMedia">
                </div>

            <div class="modal-info-body">
                <div class="modal-header-row">
                    <h2 id="modalTitle" class="modal-title-text">...</h2>
                    <span id="modalStatus" class="status-badge">...</span>
                </div>
                <div class="lat-long-row">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                    <span id="modalCoords">Lat: -, Long: -</span>
                </div>
                <div class="detail-section-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                    ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
                </div>
                <div id="modalDetail" class="detail-text"></div>
            </div>

            <div class="modal-footer">
                <button class="close-action-btn" onclick="closeModal()">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        const MAP_CENTER = [6.29445, 101.72362];
        const MAP_ZOOM = 14;
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxVKsFPtvjXIxK-lNUFi_oF_Em-lPtJPsxeng4URLW4iKKM-24KtvqvMDhFFpdn-7He_A/exec';

        const map = L.map('map', { zoomControl: false }).setView(MAP_CENTER, MAP_ZOOM);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors' }).addTo(map);

         const getStatusConfig = (status) => {
            if(status === '‡∏õ‡∏Å‡∏ï‡∏¥') return { color: '#28a745', icon: '‚úÖ', pulseClass: 'pulse-normal' };
            if(status === '‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á') return { color: '#ffc107', icon: '‚ö†Ô∏è', pulseClass: 'pulse-warning' };
            if(status === '‡∏ß‡∏¥‡∏Å‡∏§‡∏ï') return { color: '#dc3545', icon: 'üö®', pulseClass: 'pulse-danger' };
            return { color: '#6c757d', icon: '?', pulseClass: '' };
        };

        async function fetchData() {
            try {
                const response = await fetch(GAS_API_URL);
                const data = await response.json();
                if (data && data.length > 0) {
                    data.forEach(item => createMarker(item));
                }
                document.getElementById('loader').style.display = 'none';
            } catch (error) { console.error('Error:', error); }
        }

        function createMarker(item) {
            let marker;
            const config = getStatusConfig(item.status);
            if (item.type && item.type.toString().toLowerCase() === 'camera') {
                const cameraIcon = L.icon({
                    iconUrl: 'https://img5.pic.in.th/file/secure-sv1/icon86b8c7b19711828d.png',
                    iconSize: [35, 35], iconAnchor: [17, 17],
                    className: `pulse-icon ${config.pulseClass}`
                });
                marker = L.marker([item.lat, item.lng], { icon: cameraIcon });
            } else {
                marker = L.circleMarker([item.lat, item.lng], {
                    radius: 12, fillColor: config.color, color: "#fff", weight: 3, opacity: 1, fillOpacity: 0.9
                });
            }
            marker.on('click', () => openModal(item));
            marker.addTo(map);
        }

        function openModal(data) {
            const config = getStatusConfig(data.status);
            const isCamera = data.type && data.type.toString().toLowerCase() === 'camera';
            const modal = document.getElementById('infoModal');

            // 1. Media Area
            const mediaDiv = document.getElementById('modalMedia');
            let mediaHTML = `<div class="floating-close-btn" onclick="closeModal()">&times;</div>`;
            
            if (isCamera) { mediaHTML += `<div class="live-badge"><div class="live-dot"></div> LIVE</div>`; }

            if (data.img) {
                mediaHTML += `
                    <img src="${data.img}" class="modal-image" id="activeImage" alt="CCTV">
                    <div class="fullscreen-btn" onclick="triggerFullScreen()" title="‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                        </svg>
                    </div>`;
            } else {
                mediaHTML += `
                    <div style="color:white; display:flex; flex-direction:column; align-items:center;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                        <span style="margin-top:10px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏†‡∏≤‡∏û</span>
                    </div>`;
            }
            mediaDiv.innerHTML = mediaHTML;

            // 2. Info Data
            document.getElementById('modalTitle').textContent = data.title;
            const statusBadge = document.getElementById('modalStatus');
            statusBadge.innerHTML = `${config.icon} ${data.status}`;
            statusBadge.style.backgroundColor = config.color;
            statusBadge.style.color = (data.status === '‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á') ? '#333' : 'white';

            document.getElementById('modalCoords').textContent = `‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${parseFloat(data.lat).toFixed(5)}, ${parseFloat(data.lng).toFixed(5)}`;
            document.getElementById('modalDetail').textContent = data.detail || '-';

            modal.style.display = "flex";
        }

        // --- Function: Trigger Fullscreen ---
        function triggerFullScreen() {
            const img = document.getElementById('activeImage');
            if (img) {
                if (img.requestFullscreen) { img.requestFullscreen(); } 
                else if (img.webkitRequestFullscreen) { img.webkitRequestFullscreen(); } 
                else if (img.msRequestFullscreen) { img.msRequestFullscreen(); } 
            }
        }

        function closeModal() { document.getElementById('infoModal').style.display = "none"; }
        function handleOverlayClick(e) { if (e.target.id === 'infoModal') closeModal(); }

        document.addEventListener("DOMContentLoaded", fetchData);
    </script>
</body>
</html>
